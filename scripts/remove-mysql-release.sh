#!/usr/bin/env bash 
set -eu

################################################################
# object    : remove deployment
################################################################
# method    : bosh delete-deployment 
#             bosh delete-disk
################################################################
# parameter : ALIAS
#             DEPLOYMENT_NAME
################################################################

#### Initialization
export BOSH_CONFIG=$PWD/bosh-director-config/bosh_config.yml

##############################################################################################
### delete deployment
##############################################################################################
bosh -e ${ALIAS} -d ${DEPLOYMENT_NAME} delete-deployment -n --force

if [ $? = 0 ]
then 
  echo "----------------------------------------------------------------------------------"
  echo "-- delete-deployment : OK"
  echo "----------------------------------------------------------------------------------"
else
  echo "##################################################################################"
  echo "### delete-deployment : KO"
  echo "##################################################################################"
fi

##############################################################################################
### removing orphaned disks
##############################################################################################
bosh -e ${ALIAS} disks --orphaned --column "Disk CID" --column "Deployment" \
	| cat \
	| awk -v dn=${DEPLOYMENT_NAME} '{
										if($2==dn)
											{
												printf "%s\n",$1
											}
										}' \
	| xargs -i -t bosh -e ${ALIAS} -n -d ${DEPLOYMENT_NAME} delete-disk {}

if [ $? = 0 ]
then 
  echo "----------------------------------------------------------------------------------"
  echo "-- delete-disk : OK"
  echo "----------------------------------------------------------------------------------"
else
  echo "##################################################################################"
  echo "### delete-disk : KO"
  echo "##################################################################################"
fi